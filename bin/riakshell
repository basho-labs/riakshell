#!/bin/bash

# Try and make bash work safely
# Terminate on an uninitialised variable
set -u
# Terminate on error
set -e
# Terminate if any part of a pipeline fail
set -o pipefail

# Uncomment for debugging
# set -x

# gotta initialise OPTARG there
OPTARG=""
DEBUG="debug_off"
CONFIG="../etc/riakshell"
NODE="riakshell@127.0.0.1"
RUNFILE=false
FILETORUN=""
RUNFILEAS=""

while getopts "c:df:hn:r:" OPT; do
    case $OPT in
        c)
          CONFIG=$OPTARG
          ;;
        d) 
          DEBUG="debug_on"
          ;;
        f)
          RUNFILE=true
          FILETORUN=$OPTARG
          RUNFILEAS="replay"
          ;;
        h)
          echo "Usage:"
          echo "$0 -c <config> -d -f <replay_file> -n <node_name> -r <regression_file>"
          exit 1
          ;;
        n)
          NODE=$OPTARG
          ;;
        r)
          RUNFILE=true
          FILETORUN=$OPTARG
          RUNFILEAS="regression"
          ;;
        \?)
          exit 1
          ;;
       :)
          echo "Option -$OPTARG requires an argument" >&2
          exit 1
          ;;
   esac
done

# Always run from the bin directory
cd "${0%/*}"
erl -run riakshell_app boot $DEBUG $FILETORUN $RUNFILEAS -noshell -config $CONFIG -noinput -pa ../lib/riakshell*/ebin -pa ../lib/*/ebin -name $NODE
